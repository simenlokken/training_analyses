---
title: "Battle of the Heart Rate Sensors"
format: html
editor: visual
---

### Set environment and load packages

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

```{r}

library(tidyverse)

theme_set(theme_bw())
```

## Easy, indoor Zwift ride

### Load and clean data

Load data

```{r}

setwd("C:/Users/simen/Desktop/training_analyses/data")

session_1_hrm_pro <- read_csv("session_1_hrm_pro.csv")
session_1_polar_vs <- read_csv("session_1_polar_vs.csv")
session_1_forerunner_255 <- read_csv("session_1_forerunner_255.csv")

session_2_hrm_pro <- read_csv("session_2_hrm_pro.csv")
session_2_polar_vs <- read_csv("session_2_polar_vs.csv")
session_2_forerunner_255 <- read_csv("session_2_forerunner_255.csv")
```

Clean names and select relevant columns

```{r}

# HRM-Pro

session_1_hrm_pro <- session_1_hrm_pro |> 
  janitor::clean_names() |> 

session_2_hrm_pro <- session_2_hrm_pro |> 
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

# Polar VS

session_1_polar_vs <- session_1_polar_vs |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

session_2_polar_vs <- session_2_polar_vs |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

# Forerunner 255

session_1_forerunner_255 <- session_1_forerunner_255 |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

session_2_forerunner_255 <- session_2_forerunner_255 |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)
```

Synchronize data by the timestamp column

```{r}

# Session 1

session_1_hrm_vs_forerunner <- 
  left_join(session_1_hrm_pro, session_1_polar_vs, by = "record_timestamp_s") |> 
  left_join(
    session_1_forerunner_255, 
    by = "record_timestamp_s", 
    suffix = c("_hrm", "_forerunner")
  ) |> 
  rename(
    hrm_pro = record_heart_rate_bpm.x,
    polar_vs = record_heart_rate_bpm.y,
    forerunner_255 = record_heart_rate_bpm
  ) |> 
  mutate(
    elapsed_time = record_timestamp_s - min(record_timestamp_s)
  )

# Session 2

session_2_hrm_vs_forerunner <- 
  left_join(session_2_hrm_pro, session_2_polar_vs, by = "record_timestamp_s") |> 
  left_join(
    session_2_forerunner_255, 
    by = "record_timestamp_s", 
    suffix = c("_hrm", "_forerunner")
  ) |> 
  rename(
    hrm_pro = record_heart_rate_bpm.x,
    polar_vs = record_heart_rate_bpm.y,
    forerunner_255 = record_heart_rate_bpm
  ) |> 
  mutate(
    elapsed_time = record_timestamp_s - min(record_timestamp_s)
  )
```

### Analyses

Retrieve colors from RColorBrewer's Set1

```{r}

set_1_colors <- brewer.pal(9, "Set1")
```

Session 1, Forerunner 255 worn far distally on the left wrist.

```{r}

session_1_hrm_vs_forerunner |> 
  mutate(elapsed_time = elapsed_time / 60) |> 
  filter(elapsed_time < 20) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time,
        y = hrm_pro,
        color = "Garmin HRM-Pro"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = polar_vs,
        color = "Polar Verity Sense"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = forerunner_255,
        color = "Garmin Forerunner 255"),
    alpha = 0.8
  ) +
  labs(
    title = "Test 1: Indoor ride on Zwift",
    subtitle = "Easy ride with two sprints, Forerunner 255 placed distally", 
    x = "Time (minutes)",
    y = "Heart rate (BPM)",
    color = "Heart rate sensor"
  ) +
  theme_bw(base_family = "Source Sans Pro") +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "#E41A1C", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_1_all_three_devices_hr_comparison_easy_ride.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

```{r}

session_1_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    diff_vs = abs(hrm_pro - polar_vs),
    diff_255 = abs(hrm_pro - forerunner_255)
  ) |> 
  filter(elapsed_time < 20) |>
  ggplot() +
  geom_line(
    aes(x = elapsed_time,
        y = diff_vs,
        color = "Polar Verity Sense"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = diff_255,
        color = "Garmin Forerunner 255"),
    alpha = 0.8
  ) +
  labs(
    title = "Test 1: Indoor ride on Zwift, absolute difference to HRM-Pro",
    subtitle = "Easy ride with two sprints, Forerunner 255 placed distally", 
    x = "Time (minutes)",
    y = "Absolute difference in heart rate (BPM)",
    color = "Heart rate sensor"
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
   scale_color_manual(
    values = c("Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_1_all_three_devices_hr_comparison_easy_ride_abs_diff.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

Session 2, Forerunner 255 worn proximally on the left wrist.

```{r}

session_2_hrm_vs_forerunner |> 
  mutate(elapsed_time = elapsed_time / 60) |> 
  filter(elapsed_time < 20) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time,
        y = hrm_pro,
        color = "Garmin HRM-Pro"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = polar_vs,
        color = "Polar Verity Sense"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = forerunner_255,
        color = "Garmin Forerunner 255"),
    alpha = 0.8
  ) +
  labs(
    title = "Test 2: Indoor ride on Zwift",
    subtitle = "Easy ride with two sprints, Forerunner 255 placed proximally", 
    x = "Time (minutes)",
    y = "Heart rate (BPM)",
    color = "Heart rate sensor"
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "#E41A1C", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_2_all_three_devices_hr_comparison_easy_ride.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

```{r}

session_2_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    diff_vs = abs(hrm_pro - polar_vs),
    diff_255 = abs(hrm_pro - forerunner_255)
  ) |> 
  filter(elapsed_time < 20) |>
  ggplot() +
  geom_line(
    aes(x = elapsed_time,
        y = diff_vs,
        color = "Polar Verity Sense"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = diff_255,
        color = "Garmin Forerunner 255"),
    alpha = 0.8
  ) +
  labs(
    title = "Test 2: Indoor ride on Zwift, absolute difference to HRM-Pro",
    subtitle = "Easy ride with two sprints, Forerunner 255 placed proximally", 
    x = "Time (minutes)",
    y = "Absolute difference in heart rate (BPM)",
    color = "Heart rate sensor"
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
   scale_color_manual(
     values = c("Polar Verity Sense" = "#377EB8", 
                "Garmin Forerunner 255" = "#4DAF4A"
    )
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_2_all_three_devices_hr_comparison_easy_ride_abs_diff.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

## Zwift HIT session, indoor

### Load and clean data

Load data

```{r}

setwd("C:/Users/simen/Desktop/training_analyses/data")

session_3_hrm_pro <- read_csv("session_3_hrm_pro.csv")
session_3_polar_vs <- read_csv("session_3_polar_vs.csv")
session_3_forerunner_255 <- read_csv("session_3_forerunner_255.csv")
```

Clean names and select relevant columns

```{r}

# HRM-Pro

session_3_hrm_pro <- session_3_hrm_pro |> 
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

# Polar VS

session_3_polar_vs <- session_3_polar_vs |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)

# Forerunner 255

session_3_forerunner_255 <- session_3_forerunner_255 |>
  janitor::clean_names() |> 
  select(record_timestamp_s, record_heart_rate_bpm)
```

Synchronize data by the timestamp column

```{r}

session_3_hrm_vs_forerunner <- 
  left_join(session_3_hrm_pro, session_3_polar_vs, by = "record_timestamp_s") |> 
  left_join(
    session_3_forerunner_255, 
    by = "record_timestamp_s", 
    suffix = c("_hrm", "_forerunner")
  ) |> 
  rename(
    hrm_pro = record_heart_rate_bpm.x,
    polar_vs = record_heart_rate_bpm.y,
    forerunner_255 = record_heart_rate_bpm
  ) |> 
  mutate(
    elapsed_time = record_timestamp_s - min(record_timestamp_s)
  )
```

### Analyses

Session 3, Forerunner 255 worn proximally (best position) on my left wrist and VS worn on my left upper arm.

Plot of the whole session, i.e., heart rate as a function of time for all three devices

```{r}

session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    hrm_pro = hrm_pro / 195 * 100,
    polar_vs = polar_vs / 195 * 100,
    forerunner_255 = forerunner_255 / 195 * 100
  ) |>
  filter(
    elapsed_time < 51
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time, y = hrm_pro, color = "Garmin HRM-Pro"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = polar_vs, color = "Polar Verity Sense"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = forerunner_255, color = "Garmin Forerunner 255"),
    alpha = 0.7
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "#E41A1C", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  ) +
  labs(
    x = "Time (minutes)",
    y = "Heart rate (% of maximum)",
    color = "Heart rate sensor",
    title = "Test 3: HIT indoor session on Zwift",
    subtitle = "45/15 x 10 x 3, progressing from heavy to severe"
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_3_all_devices_hr_comparison_full_session.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

Plot of the absolute difference to Garmin HRM-Pro for the whole session.

```{r}

session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    diff_vs = abs(hrm_pro - polar_vs),
    diff_255 = abs(hrm_pro - forerunner_255)
  ) |>
  filter(
    elapsed_time < 51
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time,
        y = diff_vs,
        color = "Polar Verity Sense"),
    alpha = 0.8
  ) +
  geom_line(
    aes(x = elapsed_time,
        y = diff_255,
        color = "Garmin Forerunner 255"),
    alpha = 0.8
  ) +
  labs(
    title = "Test 3: HIT indoor session on Zwift, absolute difference to HRM-Pro",
    subtitle = "45/15 x 10 x 3, progressing from heavy to severe",
    y = "Absolute difference in heart rate (BPM)",
    x = "Time (minutes)",
    color = "Heart rate sensor"
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
   scale_color_manual(
     values = c("Polar Verity Sense" = "#377EB8", 
                "Garmin Forerunner 255" = "#4DAF4A"
    )
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_3_all_three_devices_hr_comparison_abs_diff.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

Taking a closer look on the second interval

```{r}

session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    hrm_pro = hrm_pro / 195 * 100,
    polar_vs = polar_vs / 195 * 100,
    forerunner_255 = forerunner_255 / 195 * 100
  ) |>
  filter(
    elapsed_time >= 24 & elapsed_time < 34
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time, y = hrm_pro, color = "Garmin HRM-Pro"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = polar_vs, color = "Polar Verity Sense"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = forerunner_255, color = "Garmin Forerunner 255"),
    alpha = 0.7
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "#E41A1C", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  ) +
  labs(
    x = "Time (minutes)",
    y = "Heart rate (% of maximum)",
    color = "Heart rate sensor",
    title = "Test 3: HIT indoor session on Zwift",
    subtitle = "Taking a closer look on the second interval"
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_3_all_devices_hr_comparison_interval_2.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

Taking a closer look on the third interval

```{r}

session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    hrm_pro = hrm_pro / 195 * 100,
    polar_vs = polar_vs / 195 * 100,
    forerunner_255 = forerunner_255 / 195 * 100
  ) |>
  filter(
    elapsed_time >= 36 & elapsed_time < 46
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time, y = hrm_pro, color = "Garmin HRM-Pro"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = polar_vs, color = "Polar Verity Sense"),
    alpha = 0.7
  ) +
  geom_line(
    aes(x = elapsed_time, y = forerunner_255, color = "Garmin Forerunner 255"),
    alpha = 0.7
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "#E41A1C", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  ) +
  labs(
    x = "Time (minutes)",
    y = "Heart rate (% of maximum)",
    color = "Heart rate sensor",
    title = "Test 3: HIT indoor session on Zwift",
    subtitle = "Taking a closer look on the third interval"
  )

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_3_all_devices_hr_comparison_interval_3.jpg",
       dpi = 300,
       height = 4,
       width = 8)
```

A plot of the interval session filling in with a three zone and a five zone intensity model

```{r}

# Three zone model

mod_1 <- session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    hrm_pro = hrm_pro / 195 * 100,
    polar_vs = polar_vs / 195 * 100,
    forerunner_255 = forerunner_255 / 195 * 100
  ) |>
  filter(
    elapsed_time < 50
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time, y = hrm_pro, color = "Garmin HRM-Pro"),
    show.legend = FALSE,
    alpha = 0.7
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 60,
        ymax = 75,
        fill = "Zone 1"),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 75,
        ymax = 87,
        fill = "Zone 2"
    ),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 87,
        ymax = 100,
        fill = "Zone 3"),
    alpha = 0.3
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_y_continuous(breaks = seq(40, 100, 10)) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "black", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  ) +
  scale_fill_manual(
    values = c("Zone 1" = "#10e84a",
               "Zone 2" = "#fab70f",
               "Zone 3" = "#fa0f1b"
    )
  ) +
  labs(
    y = "Heart rate (% of max)",
    x = NULL,
    color = "Heart rate sensor",
    fill = "Intensity domain",
    title = "How does a three zone and a five zone model differ?",
    subtitle = "45/15 x 10 x 3, progressing from heavy to severe"
  )

# Five zone model

mod_2 <- session_3_hrm_vs_forerunner |> 
  mutate(
    elapsed_time = elapsed_time / 60,
    hrm_pro = hrm_pro / 195 * 100,
    polar_vs = polar_vs / 195 * 100,
    forerunner_255 = forerunner_255 / 195 * 100
  ) |>
  filter(
    elapsed_time < 50
  ) |> 
  ggplot() +
  geom_line(
    aes(x = elapsed_time, y = hrm_pro, color = "Garmin HRM-Pro"),
    show.legend = FALSE,
    alpha = 0.7
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 60,
        ymax = 70,
        fill = "Zone 1"),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 70,
        ymax = 82.5,
        fill = "Zone 2"
    ),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 82.5,
        ymax = 87.5,
        fill = "Zone 3"),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 87.5,
        ymax = 92.5,
        fill = "Zone 4"),
    alpha = 0.3
  ) +
  geom_ribbon(
    aes(x = elapsed_time,
        ymin = 92.5,
        ymax = 100,
        fill = "Zone 5"),
    alpha = 0.3
  ) +
  theme(
    panel.grid.minor = element_blank()
  ) +
  scale_y_continuous(breaks = seq(40, 100, 10)) +
  scale_color_manual(
    values = c("Garmin HRM-Pro" = "black", 
               "Polar Verity Sense" = "#377EB8", 
               "Garmin Forerunner 255" = "#4DAF4A"
    )
  ) +
  scale_fill_manual(
    values = c("Zone 1" = "#10e84a",
               "Zone 2" = "#09ab2c",
               "Zone 3" = "#fab70f",
               "Zone 4" = "#fa0f1b",
               "Zone 5" = "#ab0e09"
    )
  ) +
  labs(
    x = "Time (minutes)",
    y = "Heart rate (% of max)",
    color = "Heart rate sensor",
    fill = "Intensity domain"
  )

mod_1 / mod_2

setwd("C:/Users/simen/Desktop/training_analyses/figures")

ggsave(file = "session_3_all_devices_hr_comparison_with_intensity_domains.jpg",
       dpi = 300,
       height = 6,
       width = 10)
```
